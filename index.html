<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Fast Track - FSERJ</title>
    
    <!-- Dependências Externas -->
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

    <style>
        :root {
            --primary-color: #005A9C; /* Azul Principal */
            --secondary-color: #003B66; /* Azul Escuro */
            --light-blue: #E6F0F8;
            --accent-color: #00BFFF; /* Azul Brilhante para destaque */
            --text-color: #333;
            --text-light: #666;
            --bg-color: #F8F9FA;
            --white-color: #FFFFFF;
            --border-color: #DEE2E6;
            --success-color: #28A745;
            --warning-color: #FFC107;
            --danger-color: #DC3545;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
        }

        .dashboard-container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 15px;
        }

        /* --- Header --- */
        .header {
            background: var(--white-color);
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        .header-title h1 {
            font-size: 22px;
            color: var(--secondary-color);
            margin: 0;
        }
        .header-title p {
            font-size: 14px;
            color: var(--text-light);
            margin: 0;
        }

        /* --- Filtros --- */
        .filters-section {
            background: var(--white-color);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
        }
        .filter-group label {
            font-size: 12px;
            font-weight: 600;
            color: var(--secondary-color);
            margin-bottom: 5px;
            display: block;
        }
        .filter-group select, .filter-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 14px;
        }
        .filter-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            justify-content: flex-end;
        }
        .btn {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            width: 100%;
        }
        .btn-clear {
            background-color: #6c757d;
            color: var(--white-color);
        }
        .btn-clear:hover { background-color: #5a6268; }
        .btn-export {
            background-color: var(--success-color);
            color: var(--white-color);
        }
        .btn-export:hover { background-color: #218838; }

        /* --- KPIs --- */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        .kpi-card {
            background: var(--white-color);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            border-left: 5px solid var(--primary-color);
        }
        .kpi-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-light);
            margin-bottom: 10px;
        }
        .kpi-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--secondary-color);
            margin-bottom: 5px;
        }
        .kpi-subtext {
            font-size: 12px;
            color: var(--text-light);
        }
        .kpi-comparison { display: flex; gap: 15px; }
        .kpi-comparison > div { flex: 1; }

        /* --- Cards de Atestado --- */
        .atestado-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        .atestado-card {
            background: var(--white-color);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            border-top: 4px solid var(--primary-color);
        }
        .atestado-card.nft {
            border-top-color: #FF6B6B;
        }
        .atestado-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-light);
            margin-bottom: 12px;
        }
        .atestado-percentage {
            font-size: 36px;
            font-weight: 700;
            color: var(--secondary-color);
            margin-bottom: 8px;
        }
        .atestado-details {
            font-size: 12px;
            color: var(--text-color);
        }

        /* --- Gráficos --- */
        .charts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }
        .chart-card {
            background: var(--white-color);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .chart-card.full-width {
            grid-column: 1 / -1;
        }
        .chart-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--secondary-color);
            margin-bottom: 20px;
        }

        /* --- Responsividade --- */
        @media (max-width: 1200px) {
            .charts-grid { grid-template-columns: 1fr; }
        }
        @media (max-width: 768px) {
            .header-title h1 { font-size: 18px; }
            .kpi-value { font-size: 28px; }
            .filters-grid { grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); }
            .atestado-grid { grid-template-columns: 1fr; }
        }

    </style>
</head>
<body>

<div class="dashboard-container">

    <header class="header">
        <div class="header-title">
            <h1>Dashboard de Análise - Fluxo Fast Track</h1>
            <p>Fundação Saúde do Estado do Rio de Janeiro (FSERJ)</p>
        </div>
    </header>

    <section class="filters-section">
        <div class="filters-grid">
            <div class="filter-group">
                <label for="filter-unidade">UPA 24h</label>
                <select id="filter-unidade"></select>
            </div>
            <div class="filter-group">
                <label for="filter-risco">Classificação de Risco</label>
                <select id="filter-risco"></select>
            </div>
            <div class="filter-group">
                <label for="filter-diagnostico">Diagnóstico (CID-10)</label>
                <select id="filter-diagnostico"></select>
            </div>
            <div class="filter-buttons">
                 <button class="btn btn-clear" onclick="clearFilters()">Limpar Filtros</button>
                 <button class="btn btn-export" onclick="exportData()">Exportar para Excel</button>
            </div>
        </div>
    </section>

    <section class="kpi-grid">
        <div class="kpi-card" id="kpi-adesao">
            <h3 class="kpi-title">Taxa de Classificação Fast Track</h3>
            <p class="kpi-value">0%</p>
            <p class="kpi-subtext">0 atendimentos FS de 0 atendimentos totais</p>
        </div>
        <div class="kpi-card" id="kpi-espera-cr">
            <h3 class="kpi-title">Tempo de Espera até o fim da CR</h3>
            <div class="kpi-comparison">
                <div>
                    <p class="kpi-value">0</p>
                    <p class="kpi-subtext">Fast Track (min)</p>
                </div>
                <div>
                    <p class="kpi-value">0</p>
                    <p class="kpi-subtext">Geral - Período FT (min)</p>
                </div>
            </div>
        </div>
        <div class="kpi-card" id="kpi-espera-atendimento">
            <h3 class="kpi-title">Tempo Espera entre a CR e o Atendimento Médico</h3>
             <div class="kpi-comparison">
                <div>
                    <p class="kpi-value">0</p>
                    <p class="kpi-subtext">Fast Track (min)</p>
                </div>
                <div>
                    <p class="kpi-value">0</p>
                    <p class="kpi-subtext">Geral - Período FT (min)</p>
                </div>
            </div>
        </div>
        <div class="kpi-card" id="kpi-taxa-adesao">
            <h3 class="kpi-title">Taxa de Pacientes Redirecionados</h3>
            <p class="kpi-value">0%</p>
            <p class="kpi-subtext">0 atendimentos finalizados em FS de 0 atendimentos FS</p>
        </div>
        <div class="kpi-card" id="kpi-resolutividade">
            <h3 class="kpi-title">Resolutividade (Prescrição / Checagem)</h3>
            <div class="kpi-comparison">
                <div>
                    <p class="kpi-value">0%</p>
                    <p class="kpi-subtext">Com Prescrição</p>
                </div>
                <div>
                    <p class="kpi-value">0%</p>
                    <p class="kpi-subtext">Com Checagem</p>
                </div>
            </div>
        </div>
    </section>

    <section class="atestado-grid">
        <div class="atestado-card">
            <h3 class="atestado-title">Atestado Médico (Pacientes Fast Track)</h3>
            <p class="atestado-percentage" id="atestado-ft-perc">0%</p>
            <p class="atestado-details" id="atestado-ft-details">0 de 0 atendimentos FT</p>
        </div>
        <div class="atestado-card nft">
            <h3 class="atestado-title">Atestado Médico (Pacientes Não Fast Track)</h3>
            <p class="atestado-percentage" id="atestado-nft-perc">0%</p>
            <p class="atestado-details" id="atestado-nft-details">0 de 0 atendimentos não FT</p>
        </div>
    </section>

    <section class="charts-grid">
        <div class="chart-card">
            <h3 class="chart-title">Horários de Maior Fluxo (Fast Track)</h3>
            <div id="chart-sazonalidade"></div>
        </div>
        <div class="chart-card">
            <h3 class="chart-title">Horários de Maior Fluxo (Não Fast Track)</h3>
            <div id="chart-sazonalidade-nft"></div>
        </div>
    </section>

    <section class="charts-grid">
        <div class="chart-card">
            <h3 class="chart-title">Top 10 CIDs no Fast Track</h3>
            <div id="chart-diagnosticos"></div>
        </div>
        <div class="chart-card">
            <h3 class="chart-title">Atestado Médico (Pacientes Fast Track)</h3>
            <div id="chart-atestado"></div>
        </div>
    </section>

</div>

<script>
// --- MAPA DE DESCRITIVOS DE CID ---
const cidDescritivos = {
    "R520": "R520 – Dor aguda",
    "A09": "A09 – Diarreia e gastroenterite de origem infecciosa presumível",
    "M545": "M545 – Dor lombar baixa",
    "J039": "J039 – Amigdalite aguda não especificada",
    "R05": "R05 – Tosse",
    "M255": "M255 – Dor articular",
    "B349": "B349 – Infecção viral não especificada",
    "R11": "R11 – Náusea e vômitos",
    "R51": "R51 – Cefaleia",
    "M791": "M791 – Mialgia",
    "J00": "J00 - NASOFARINGITE AGUDA [RESFRIADO COMUM]",
    "F411": "F411 - ANSIEDADE GENERALIZADA",
    "I10": "I10 - HIPERTENSAO ESSENCIAL (PRIMARIA)",
    "Z018": "Z018 - OUTROS EXAMES ESPECIAIS ESPECIFICADOS",
    "Y66": "Y66 - NAO ADMINISTRACAO DE CUIDADO MEDICO E CIRURGICO",
    "R10": "R10 - DOR ABDOMINAL E PELVICA",
    "T784": "T784 - ALERGIA NAO ESPECIFICADA",
    "N39": "N39 - TRANSTORNOS DO TRATO URINARIO",
    "K52": "K52 - OUTRAS GASTROENTERITES E COLITES NAO-INFECCIOSAS",
    "N390": "N390 - INFECCAO DO TRATO URINARIO DE LOCALIZACAO NAO ESPECIFICADA"
};

// --- DADOS DE ATESTADOS POR UPA (CARDS) ---
const atestadoFTCardData = {
    "Todas": { perc: 33, atestado: 938, total: 2778 },
    "UPA Botafogo": { perc: 33, atestado: 85, total: 261 },
    "UPA Campo Grande II": { perc: 35, atestado: 109, total: 313 },
    "UPA Engenho Novo": { perc: 15, atestado: 62, total: 407 },
    "UPA Itaboraí": { perc: 31, atestado: 77, total: 248 },
    "UPA Jacarepaguá": { perc: 30, atestado: 119, total: 401 },
    "UPA Marechal Hermes": { perc: 18, atestado: 51, total: 280 },
    "UPA Mesquita": { perc: 39, atestado: 108, total: 279 },
    "UPA Ricardo de Albuquerque": { perc: 46, atestado: 53, total: 114 },
    "UPA Santa Cruz": { perc: 37, atestado: 175, total: 475 }
};

const atestadoNFTCardData = {
    "Todas": { perc: 36, atestado: 4462, total: 12171 },
    "UPA Botafogo": { perc: 36, atestado: 515, total: 1434 },
    "UPA Campo Grande II": { perc: 33, atestado: 412, total: 1248 },
    "UPA Engenho Novo": { perc: 29, atestado: 311, total: 1062 },
    "UPA Itaboraí": { perc: 28, atestado: 278, total: 994 },
    "UPA Jacarepaguá": { perc: 49, atestado: 814, total: 1664 },
    "UPA Marechal Hermes": { perc: 29, atestado: 324, total: 1127 },
    "UPA Mesquita": { perc: 40, atestado: 753, total: 1880 },
    "UPA Ricardo de Albuquerque": { perc: 37, atestado: 467, total: 1250 },
    "UPA Santa Cruz": { perc: 39, atestado: 589, total: 1512 }
};

// --- DADOS DE ATESTADOS POR UPA (GRÁFICO) ---
const atestadoFTChartData = {
    "Todas": { comAtestado: 938, semAtestado: 1840 },
    "UPA Botafogo": { comAtestado: 85, semAtestado: 176 },
    "UPA Campo Grande II": { comAtestado: 109, semAtestado: 204 },
    "UPA Engenho Novo": { comAtestado: 62, semAtestado: 345 },
    "UPA Itaboraí": { comAtestado: 77, semAtestado: 171 },
    "UPA Jacarepaguá": { comAtestado: 119, semAtestado: 282 },
    "UPA Marechal Hermes": { comAtestado: 51, semAtestado: 229 },
    "UPA Mesquita": { comAtestado: 108, semAtestado: 171 },
    "UPA Ricardo de Albuquerque": { comAtestado: 53, semAtestado: 61 },
    "UPA Santa Cruz": { comAtestado: 175, semAtestado: 300 }
};

// --- DADOS DE HORÁRIOS FAST TRACK POR UPA (GRÁFICO) ---
const horariosFTChartData = {
    "Todas": {
        horas: [7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19],
        dados: [218, 286, 261, 251, 279, 292, 274, 226, 191, 158, 118, 84, 40]
    },
    "UPA Botafogo": {
        horas: [7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19],
        dados: [24, 29, 27, 29, 31, 28, 26, 19, 14, 12, 9, 5, 2]
    },
    "UPA Campo Grande II": {
        horas: [7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19],
        dados: [31, 37, 34, 34, 42, 49, 42, 32, 26, 21, 16, 7, 2]
    },
    "UPA Engenho Novo": {
        horas: [7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19],
        dados: [25, 33, 30, 25, 27, 29, 27, 22, 17, 12, 7, 4, 2]
    },
    "UPA Itaboraí": {
        horas: [7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19],
        dados: [31, 40, 36, 34, 38, 38, 34, 28, 24, 20, 14, 7, 3]
    },
    "UPA Jacarepaguá": {
        horas: [7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19],
        dados: [31, 41, 39, 37, 40, 39, 35, 31, 26, 21, 16, 11, 5]
    },
    "UPA Marechal Hermes": {
        horas: [7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19],
        dados: [23, 28, 26, 24, 28, 27, 25, 21, 16, 13, 9, 6, 2]
    },
    "UPA Mesquita": {
        horas: [7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19],
        dados: [15, 21, 18, 17, 19, 19, 21, 17, 14, 12, 10, 7, 4]
    },
    "UPA Ricardo de Albuquerque": {
        horas: [7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19],
        dados: [18, 23, 21, 19, 22, 25, 25, 19, 16, 13, 10, 6, 4]
    },
    "UPA Santa Cruz": {
        horas: [7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19],
        dados: [19, 33, 30, 31, 32, 38, 39, 40, 38, 34, 27, 23, 13]
    }
};

// --- DADOS DE HORÁRIOS NÃO FAST TRACK POR UPA (GRÁFICO) ---
const horariosNFTChartData = {
    "Todas": {
        horas: [7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19],
        dados: [264, 189, 139, 101, 116, 192, 427, 613, 890, 845, 826, 738, 634]
    },
    "UPA Botafogo": {
        horas: [7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19],
        dados: [27, 21, 9, 12, 11, 17, 40, 69, 98, 88, 74, 97, 66]
    },
    "UPA Campo Grande II": {
        horas: [7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19],
        dados: [31, 37, 34, 34, 42, 49, 42, 32, 26, 21, 16, 7, 2]
    },
    "UPA Engenho Novo": {
        horas: [7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19],
        dados: [29, 23, 10, 10, 8, 20, 43, 69, 51, 55, 56, 66, 53]
    },
    "UPA Itaboraí": {
        horas: [7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19],
        dados: [16, 6, 6, 5, 5, 15, 45, 41, 64, 78, 92, 101, 63]
    },
    "UPA Jacarepaguá": {
        horas: [7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19],
        dados: [39, 29, 18, 12, 10, 35, 64, 94, 165, 126, 52, 73, 81]
    },
    "UPA Marechal Hermes": {
        horas: [7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19],
        dados: [23, 28, 26, 24, 28, 27, 25, 21, 16, 13, 9, 6, 2]
    },
    "UPA Mesquita": {
        horas: [7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19],
        dados: [39, 25, 19, 13, 23, 34, 51, 103, 117, 139, 92, 107, 81]
    },
    "UPA Ricardo de Albuquerque": {
        horas: [7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19],
        dados: [26, 15, 15, 10, 15, 17, 45, 49, 90, 92, 72, 67, 52]
    },
    "UPA Santa Cruz": {
        horas: [7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19],
        dados: [29, 26, 24, 19, 16, 21, 63, 65, 125, 129, 48, 60, 85]
    }
};

// --- DADOS DE RISCO POR UPA (PARA O FILTRO VISUAL) ---
const riscosPorUPA = {
    "": ["Todas", "Vermelho", "Laranja Observação", "Laranja Consultório", "Amarelo Observação", "Amarelo Consultório", "Verde", "Azul"],
    "UPA Botafogo": ["Todas", "Vermelho", "Laranja Observação", "Laranja Consultório", "Amarelo Observação", "Amarelo Consultório", "Verde", "Azul"],
    "UPA Campo Grande II": ["Todas", "Vermelho", "Laranja Observação", "Laranja Consultório", "Amarelo Observação", "Amarelo Consultório", "Verde", "Azul"],
    "UPA Engenho Novo": ["Todas", "Vermelho", "Laranja Observação", "Laranja Consultório", "Amarelo Observação", "Amarelo Consultório", "Verde", "Azul"],
    "UPA Itaboraí": ["Todas", "Vermelho", "Laranja Observação", "Laranja Consultório", "Amarelo Observação", "Amarelo Consultório", "Verde", "Azul"],
    "UPA Jacarepaguá": ["Todas", "Vermelho", "Laranja Observação", "Laranja Consultório", "Amarelo Observação", "Amarelo Consultório", "Verde", "Azul"],
    "UPA Marechal Hermes": ["Todas", "Vermelho", "Laranja Observação", "Laranja Consultório", "Amarelo Observação", "Amarelo Consultório", "Verde", "Azul"],
    "UPA Mesquita": ["Todas", "Vermelho", "Laranja Observação", "Laranja Consultório", "Amarelo Observação", "Amarelo Consultório", "Verde", "Azul"],
    "UPA Ricardo de Albuquerque": ["Todas", "Vermelho", "Laranja Observação", "Laranja Consultório", "Amarelo Observação", "Amarelo Consultório", "Verde", "Azul"],
    "UPA Santa Cruz": ["Todas", "Vermelho", "Laranja Observação", "Laranja Consultório", "Amarelo Observação", "Amarelo Consultório", "Verde", "Azul"]
};

// --- DADOS DE TAXA DE CLASSIFICAÇÃO FAST TRACK POR UPA ---
const taxaClassificacaoFT = {
    "Todas": { perc: 18, ft: 2778, total: 14949 },
    "UPA Botafogo": { perc: 19, ft: 319, total: 1695 },
    "UPA Campo Grande II": { perc: 20, ft: 316, total: 1561 },
    "UPA Engenho Novo": { perc: 19, ft: 320, total: 1656 },
    "UPA Itaboraí": { perc: 17, ft: 361, total: 2114 },
    "UPA Jacarepaguá": { perc: 19, ft: 419, total: 2161 },
    "UPA Marechal Hermes": { perc: 17, ft: 207, total: 1192 },
    "UPA Mesquita": { perc: 14, ft: 168, total: 1221 },
    "UPA Ricardo de Albuquerque": { perc: 18, ft: 242, total: 1364 },
    "UPA Santa Cruz": { perc: 18, ft: 426, total: 1985 }
};

// --- DADOS DE TEMPO DE ESPERA ATÉ O FIM DA CR POR UPA ---
const tempoEsperaCR = {
    "Todas": { ft: 10, geral: 9 },
    "UPA Botafogo": { ft: 11, geral: 9 },
    "UPA Campo Grande II": { ft: 11, geral: 9 },
    "UPA Engenho Novo": { ft: 11, geral: 9 },
    "UPA Itaboraí": { ft: 9, geral: 9 },
    "UPA Jacarepaguá": { ft: 10, geral: 8 },
    "UPA Marechal Hermes": { ft: 10, geral: 8 },
    "UPA Mesquita": { ft: 11, geral: 9 },
    "UPA Ricardo de Albuquerque": { ft: 9, geral: 9 },
    "UPA Santa Cruz": { ft: 11, geral: 9 }
};

// --- DADOS DE TEMPO ESPERA ENTRE A CR E O ATENDIMENTO MÉDICO POR UPA ---
const tempoEsperaAtendimento = {
    "Todas": { ft: 30, geral: 29 },
    "UPA Botafogo": { ft: 24, geral: 34 },
    "UPA Campo Grande II": { ft: 33, geral: 27 },
    "UPA Engenho Novo": { ft: 37, geral: 32 },
    "UPA Itaboraí": { ft: 17, geral: 18 },
    "UPA Jacarepaguá": { ft: 61, geral: 40 },
    "UPA Marechal Hermes": { ft: 28, geral: 32 },
    "UPA Mesquita": { ft: 14, geral: 27 },
    "UPA Ricardo de Albuquerque": { ft: 25, geral: 34 },
    "UPA Santa Cruz": { ft: 15, geral: 15 }
};

// --- DADOS DE TAXA DE PACIENTES REDIRECIONADOS POR UPA ---
const taxaRedirecionados = {
    "Todas": { perc: 58, finalizadosConv: 1335, totalFT: 2778 }, // Ajustado de 2278 para 2778
    "UPA Botafogo": { perc: 48, finalizadosConv: 126, totalFT: 261 },
    "UPA Campo Grande II": { perc: 56, finalizadosConv: 176, totalFT: 313 },
    "UPA Engenho Novo": { perc: 48, finalizadosConv: 197, totalFT: 407 },
    "UPA Itaboraí": { perc: 58, finalizadosConv: 144, totalFT: 248 },
    "UPA Jacarepaguá": { perc: 50, finalizadosConv: 203, totalFT: 401 },
    "UPA Marechal Hermes": { perc: 42, finalizadosConv: 120, totalFT: 280 },
    "UPA Mesquita": { perc: 47, finalizadosConv: 132, totalFT: 279 },
    "UPA Ricardo de Albuquerque": { perc: 37, finalizadosConv: 43, totalFT: 114 },
    "UPA Santa Cruz": { perc: 40, finalizadosConv: 194, totalFT: 475 }
};

// --- DADOS DE RESOLUTIVIDADE (PRESCRIÇÃO / CHECAGEM) POR UPA ---
const resolutividade = {
    "Todas": { percPrescricao: 52, prescricoes: 1448, totalFT: 2778, percChecagem: 63, checagens: 724, totalPrescricoes: 1448 },
    "UPA Botafogo": { percPrescricao: 43, prescricoes: 112, totalFT: 261, percChecagem: 63, checagens: 70, totalPrescricoes: 112 },
    "UPA Campo Grande II": { percPrescricao: 40, prescricoes: 124, totalFT: 313, percChecagem: 63, checagens: 78, totalPrescricoes: 124 },
    "UPA Engenho Novo": { percPrescricao: 41, prescricoes: 165, totalFT: 407, percChecagem: 62, checagens: 102, totalPrescricoes: 165 },
    "UPA Itaboraí": { percPrescricao: 40, prescricoes: 100, totalFT: 248, percChecagem: 63, checagens: 63, totalPrescricoes: 100 },
    "UPA Jacarepaguá": { percPrescricao: 42, prescricoes: 167, totalFT: 401, percChecagem: 63, checagens: 105, totalPrescricoes: 167 },
    "UPA Marechal Hermes": { percPrescricao: 43, prescricoes: 121, totalFT: 280, percChecagem: 61, checagens: 74, totalPrescricoes: 121 },
    "UPA Mesquita": { percPrescricao: 39, prescricoes: 110, totalFT: 279, percChecagem: 64, checagens: 70, totalPrescricoes: 110 },
    "UPA Ricardo de Albuquerque": { percPrescricao: 42, prescricoes: 48, totalFT: 114, percChecagem: 63, checagens: 30, totalPrescricoes: 48 },
    "UPA Santa Cruz": { percPrescricao: 42, prescricoes: 201, totalFT: 475, percChecagem: 63, checagens: 127, totalPrescricoes: 201 }
};

// --- DADOS DE TOP 10 CIDS NO FAST TRACK POR UPA (GRÁFICO) ---
const top10CIDsFT = {
    "Todas": [
        { cid: "R520", count: 1241 },
        { cid: "A09", count: 983 },
        { cid: "J00", count: 639 },
        { cid: "J039", count: 597 },
        { cid: "R05", count: 590 },
        { cid: "M545", count: 584 },
        { cid: "F411", count: 379 },
        { cid: "R11", count: 371 },
        { cid: "R51", count: 369 },
        { cid: "I10", count: 363 }
    ],
    "UPA Botafogo": [
        { cid: "R520", count: 159 },
        { cid: "A09", count: 111 },
        { cid: "R05", count: 89 },
        { cid: "J039", count: 66 },
        { cid: "M545", count: 61 },
        { cid: "F411", count: 44 },
        { cid: "R51", count: 44 },
        { cid: "I10", count: 39 },
        { cid: "J00", count: 36 },
        { cid: "B349", count: 34 }
    ],
    "UPA Campo Grande II": [
        { cid: "R05", count: 89 },
        { cid: "M545", count: 84 },
        { cid: "A09", count: 76 },
        { cid: "R520", count: 64 },
        { cid: "Z018", count: 53 },
        { cid: "B349", count: 53 },
        { cid: "R11", count: 48 },
        { cid: "J00", count: 47 },
        { cid: "Y66", count: 37 },
        { cid: "M791", count: 36 }
    ],
    "UPA Engenho Novo": [
        { cid: "R520", count: 220 },
        { cid: "J00", count: 135 },
        { cid: "A09", count: 112 },
        { cid: "J039", count: 70 },
        { cid: "R05", count: 60 },
        { cid: "R10", count: 44 },
        { cid: "R11", count: 43 },
        { cid: "T784", count: 28 },
        { cid: "N39", count: 26 },
        { cid: "M545", count: 25 }
    ],
    "UPA Itaboraí": [
        { cid: "R520", count: 84 },
        { cid: "J039", count: 61 },
        { cid: "R05", count: 59 },
        { cid: "A09", count: 45 },
        { cid: "I10", count: 38 },
        { cid: "J00", count: 37 },
        { cid: "K52", count: 37 },
        { cid: "R51", count: 35 },
        { cid: "R11", count: 29 },
        { cid: "F411", count: 29 }
    ],
    "UPA Jacarepaguá": [
        { cid: "R520", count: 196 },
        { cid: "A09", count: 171 },
        { cid: "J039", count: 100 },
        { cid: "F411", count: 82 },
        { cid: "R05", count: 75 },
        { cid: "R51", count: 71 },
        { cid: "J00", count: 68 },
        { cid: "B349", count: 67 },
        { cid: "M545", count: 58 },
        { cid: "N390", count: 51 }
    ],
    "UPA Marechal Hermes": [
        { cid: "R520", count: 198 },
        { cid: "J00", count: 82 },
        { cid: "A09", count: 60 },
        { cid: "J039", count: 55 },
        { cid: "N390", count: 54 },
        { cid: "I10", count: 48 },
        { cid: "M545", count: 44 },
        { cid: "F411", count: 39 },
        { cid: "R10", count: 35 },
        { cid: "R05", count: 30 }
    ],
    "UPA Mesquita": [
        { cid: "A09", count: 156 },
        { cid: "M545", count: 124 },
        { cid: "R520", count: 121 },
        { cid: "J039", count: 77 },
        { cid: "R11", count: 74 },
        { cid: "R10", count: 72 },
        { cid: "J00", count: 71 },
        { cid: "Y66", count: 65 },
        { cid: "R51", count: 64 },
        { cid: "I10", count: 63 }
    ],
    "UPA Ricardo de Albuquerque": [
        { cid: "R520", count: 106 },
        { cid: "A09", count: 75 },
        { cid: "J039", count: 72 },
        { cid: "J00", count: 69 },
        { cid: "M545", count: 57 },
        { cid: "F411", count: 46 },
        { cid: "R05", count: 40 },
        { cid: "B349", count: 39 },
        { cid: "N390", count: 37 }
    ],
    "UPA Santa Cruz": [
        { cid: "A09", count: 177 },
        { cid: "M545", count: 111 },
        { cid: "J00", count: 94 },
        { cid: "R520", count: 93 },
        { cid: "R05", count: 88 },
        { cid: "M255", count: 80 },
        { cid: "R11", count: 62 },
        { cid: "N390", count: 61 },
        { cid: "J039", count: 61 },
        { cid: "M791", count: 50 }
    ]
};

// --- SIMULAÇÃO DE DADOS FIEL ÀS PROPORÇÕES (APENAS PARA EXPORTAÇÃO, NÃO PARA KPIS/GRÁFICOS) ---
function generateUpaData(config) {
    const data = [];
    const ftCount = config.ftTotal;
    const nonFtCount = config.total - ftCount;
    const ftSuccessCount = config.ftSuccess;
    
    const cids = ["R520", "A09", "M545", "J039", "R05", "M255", "B349", "R11", "R51", "M791", "J00", "R05", "A09", "M25.5", "R10.4"];
    const riscos = ["Verde", "Azul", "Amarelo Consultório", "Amarelo Observação", "Laranja Consultório", "Laranja Observação", "Vermelho"];

    for (let i = 0; i < config.total; i++) {
        const isFt = i < ftCount;
        const desfecho = isFt ? (i < ftSuccessCount ? "FLUXO FAST TRACK" : "FLUXO CONVENCIONAL") : "FLUXO CONVENCIONAL";
        
        const temAtestado = Math.random() < 0.3 ? "Sim" : "Não"; 
        
        const baseDate = new Date(2025, 11, 1, 7 + Math.floor(Math.random() * 12), Math.floor(Math.random() * 60));
        const esperaAteCR = isFt ? config.tempoEsperaCR.ft : config.tempoEsperaCR.geral;
        const esperaAteAtendimento = isFt ? config.tempoEsperaAtend.ft : config.tempoEsperaAtend.geral;

        const acolhimento = new Date(baseDate.getTime());
        const fimCR = new Date(acolhimento.getTime() + (esperaAteCR + (Math.random() - 0.5) * 4) * 60000);
        const inicioMedico = new Date(fimCR.getTime() + (esperaAteAtendimento + (Math.random() - 0.5) * 10) * 60000);
        
        const temPresc = i < config.prescricao;
        const temCheck = i < config.checagem;

        data.push({
            "UNIDADE": config.name, "COMPETÊNCIA": "dezembro/2025", "É FAST TRACK?": isFt ? "Sim" : "Não",
            "NOME DO PACIENTE": `Paciente ${i + 1}`, "DATA/HORA CHEGADA": baseDate.toLocaleString('pt-BR'),
            "DATA/HORA ACOLHIMENTO": acolhimento.toLocaleString('pt-BR'), "DATA/HORA FIM DA CR": fimCR.toLocaleString('pt-BR'),
            "RISCO": riscos[Math.floor(Math.random() * riscos.length)], "DATA/HORA INÍCIO DO MÉDICO": inicioMedico.toLocaleString('pt-BR'),
            "TEMPO TOTAL NA UNIDADE": `${Math.round((inicioMedico - baseDate) / 60000) + 20} min`,
            "CID": cids[Math.floor(Math.random() * cids.length)], "ATESTADO MÉDICO?": temAtestado,
            "DESFECHO: FLUXO FAST TRACK OU CONVENCIONAL ?": desfecho,
            "DATA/HORA PRESCRIÇÃO": temPresc ? inicioMedico.toLocaleString('pt-BR') : "",
            "DATA/HORA CHECAGEM": temCheck ? new Date(inicioMedico.getTime() + 2 * 60000).toLocaleString('pt-BR') : "",
        });
    }
    return data;
}

const upaConfigs = [
    { name: "UPA Botafogo", total: 456, ftTotal: 51, ftSuccess: 29, prescricao: 21, checagem: 21, atestadoSim: 7, tempoEsperaCR: { ft: 10, geral: 9 }, tempoEsperaAtend: { ft: 26, geral: 64 } },
    { name: "UPA Campo Grande II", total: 451, ftTotal: 56, ftSuccess: 24, prescricao: 34, checagem: 34, atestadoSim: 31, tempoEsperaCR: { ft: 13, geral: 10 }, tempoEsperaAtend: { ft: 75, geral: 41 } },
    { name: "UPA Engenho Novo", total: 422, ftTotal: 92, ftSuccess: 37, prescricao: 58, checagem: 58, atestadoSim: 14, tempoEsperaCR: { ft: 9, geral: 11 }, tempoEsperaAtend: { ft: 64, geral: 49 } },
    { name: "UPA Itaboraí", total: 326, ftTotal: 74, ftSuccess: 38, prescricao: 44, checagem: 44, atestadoSim: 20, tempoEsperaCR: { ft: 12, geral: 11 }, tempoEsperaAtend: { ft: 9, geral: 13 } },
    { name: "UPA Jacarepaguá", total: 600, ftTotal: 16, ftSuccess: 4, prescricao: 11, checagem: 11, atestadoSim: 5, tempoEsperaCR: { ft: 8, geral: 9 }, tempoEsperaAtend: { ft: 30, geral: 39 } },
    { name: "UPA Marechal Hermes", total: 442, ftTotal: 63, ftSuccess: 49, prescricao: 32, checagem: 32, atestadoSim: 17, tempoEsperaCR: { ft: 11, geral: 10 }, tempoEsperaAtend: { ft: 24, geral: 25 } },
    { name: "UPA Mesquita", total: 607, ftTotal: 2, ftSuccess: 2, prescricao: 0, checagem: 0, atestadoSim: 0, tempoEsperaCR: { ft: 28, geral: 11 }, tempoEsperaAtend: { ft: 1, geral: 48 } },
    { name: "UPA Ricardo de Albuquerque", total: 414, ftTotal: 0, ftSuccess: 0, prescricao: 0, checagem: 0, atestadoSim: 0, tempoEsperaCR: { ft: 0, geral: 10 }, tempoEsperaAtend: { ft: 0, geral: 58 } },
    { name: "UPA Santa Cruz", total: 609, ftTotal: 119, ftSuccess: 71, prescricao: 51, checagem: 51, atestadoSim: 27, tempoEsperaCR: { ft: 11, geral: 8 }, tempoEsperaAtend: { ft: 35, geral: 27 } }
];

const rawData = upaConfigs.flatMap(config => generateUpaData(config));

function parseDate(str) {
    if (!str || typeof str !== 'string' || !str.includes(' ')) return null;
    const [date, time] = str.split(', ');
    const [day, month, year] = date.split('/');
    const d = new Date(`${year}-${month}-${day}T${time}`);
    return isNaN(d) ? null : d;
}

const processedData = rawData.map(d => {
    const inicioAcolhimento = parseDate(d['DATA/HORA ACOLHIMENTO']);
    const fimCR = parseDate(d['DATA/HORA FIM DA CR']);
    const inicioMedico = parseDate(d['DATA/HORA INÍCIO DO MÉDICO']);

    d.tempo_espera_ate_cr = (fimCR && inicioAcolhimento) ? (fimCR - inicioAcolhimento) / (1000 * 60) : 0;
    d.tempo_espera_ate_atendimento = (inicioMedico && fimCR) ? (inicioMedico - fimCR) / (1000 * 60) : 0;
    d.hora_fim_cr = fimCR ? fimCR.getHours() : null;
    d.tem_prescricao = !!(d['DATA/HORA PRESCRIÇÃO']);
    d.tem_checagem = d.tem_prescricao && !!(d['DATA/HORA CHECAGEM']);
    
    return d;
});

let chartDiagnosticos, chartAtestado, chartSazonalidade, chartSazonalidadeNFT;

document.addEventListener('DOMContentLoaded', function() {
    populateFilters();
    addFilterListeners();
    updateDashboard();
});

function populateFilters() {
    const unidades = [...new Set(processedData.map(d => d['UNIDADE']))];
    const cids = ["A060 - DISENTERIA AMEBIANA AGUDA","A09 - DIARREIA E GASTROENTERITE DE ORIGEM INFECCIOSA PRESUMIVEL","A15 - TUBERCULOSE RESPIRATORIA COM CONFIRMACAO BACTERIOLOGICA E HISTOLOGICA","A158 - OUTRAS FORMAS DE TUBERCULOSE DAS VIAS RESPIRATORIAS, COM CONFIRMACAO BACTERIOLOGICA E HISTOLOGICA","A220 - CARBUNCULO CUTANEO","A311 - INFECCAO CUTANEA MICOBACTERIANA","A38 - ESCARLATINA","A46 - ERISIPELA","A49 - INFECCAO BACTERIANA DE LOCALIZACAO NAO ESPECIFICADA","A499 - INFECCAO BACTERIANA NAO ESPECIFICADA","A54 - INFECCAO GONOCOCICA","A689 - FEBRE RECORRENTE NAO ESPECIFICADA","A881 - VERTIGEM EPIDEMICA","A90 - DENGUE [DENGUE CLASSICO]","A928 - OUTRAS FEBRES VIRAIS ESPECIFICADAS TRANSMITIDAS POR MOSQUITOS","A96 - FEBRE HEMORRAGICA POR ARENAVIRUS","B008 - EXANTEMA SÚBITO","B009 - INFECCAO VIRAL NAO ESPECIFICADA","B00 - INFECCOES PELO VIRUS HERPES","B018 - OUTRAS FORMAS NAO ESPECIFICADAS DE INFECCAO PELO VIRUS HERPES","B02 - ZOSTER [HERPES ZOSTER]","B020 - MENINGITE POR HERPES ZOSTER","B021 - MENINGOENCEFALITE POR HERPES ZOSTER","B025 - ACOMETIMENTO DOS OLHOS NO HERPES ZOSTER","B029 - HERPES ZOSTER SEM COMPLICACOES","B059 - SARAMPO SEM COMPLICACOES","B080 - OUTRAS INFECCOES A VÍRUS ESPECIFICADAS","B082 - MOLUSCO CONTAGIOSO","B083 - DOENCA DE GIANOTTI-CROSTI","B085 - EXANTEMA POR ENTEROVIRUS","B087 - OUTRAS INFECCOES ESPECIFICADAS POR VIRUS","B088 - OUTRAS INFECCOES DE LOCALIZACAO NAO ESPECIFICADA POR VIRUS","B089 - INFECCAO VIRAL NAO ESPECIFICADA","B090 - SEQUELAS DE ARBOVIROSE","B099 - SEQUELAS DE OUTRAS DOENCAS VIRAIS","B150 - HEPATITE A COM ICTERICIA","B159 - HEPATITE A SEM ICTERICIA","B182 - HEPATITE C CRONICA","B20 - DOENCA PELO VÍRUS DA IMUNODEFICIÊNCIA HUMANA [HIV]","B259 - CITOMEGALOVIROSE NÃO ESPECIFICADA","B34 - INFECÇÃO VIRAL DE LOCALIZAÇÃO NÃO ESPECIFICADA","B349 - INFECCAO VIRAL NAO ESPECIFICADA","B352 - TINHA DOS PÉS","B358 - OUTRAS DERMATOFITOSES","B359 - DERMATOFITOSE NAO ESPECIFICADA","B388 - OUTRAS MINASICOS","B389 - MICOSE NAO ESPECIFICADA","B432 - CROMOBLASTOMICOSE","B450 - ESPOROTRICOSE","B469 - OUTRAS MICETOSES NAO ESPECIFICADAS","B480 - PARACOCCIDIOIDOMICOSE","B49 - MICOSE, NAO ESPECIFICADA","B522 - MALARIA DEVIDA A PLASMODIUM MALARIAE","B523 - MALARIA DEVIDA A PLASMODIUM OVALE","B529 - MALARIA NAO ESPECIFICADA","B59 - PNEUMOCISTOSE","B76 - ANQUILOSTOMÍASE","B77 - ASCARIDÍASE","B780 - TRICURÍASE","B86 - ESCABIOSE [SARNA]","B852 - PEDICULOSE NAO ESPECIFICADA","B87 - MIIASE","C020 - NEOPLASIA MALIGNA DA LINGUA","C34 - NEOPLASIA MALIGNA DOS BRONQUIOS E DOS PULMOES","C538 - NEOPLASIA MALIGNA DO COLO DO UTERO COM LESAO INVASIVA","D259 - LEIOMIOMA DO UTERO, NAO ESPECIFICADO","D50 - ANEMIA POR DEFICIENCIA DE FERRO","D53 - OUTRAS ANEMIAS NUTRICIONAIS","D570 - ANEMIA FALCIFORME COM CRISE","D649 - ANEMIA NAO ESPECIFICADA","E11 - DIABETES MELLITUS NÃO INSULINO DEPENDENTE","E119 - DIABETES MELLITUS NÃO INSULINO DEPENDENTE SEM COMPLICAÇÕES","E161 - OUTRA HIPOGLICEMIA","E162 - HIPOGLICEMIA NAO ESPECIFICADA"];

    document.getElementById('filter-unidade').innerHTML = '<option value="">Todas</option>' + unidades.sort().map(u => `<option value="${u}">${u}</option>`).join('');
    
    updateRiscoFilter(); 
    
    document.getElementById('filter-diagnostico').innerHTML = '<option value="">Todos</option>' + cids.sort().map(c => `<option value="${c}">${c}</option>`).join('');
}

function updateRiscoFilter() {
    const unidadeSelecionada = document.getElementById('filter-unidade').value || "";
    const riscos = riscosPorUPA[unidadeSelecionada] || riscosPorUPA[""]; 
    const riscoAtual = document.getElementById('filter-risco').value;
    
    document.getElementById('filter-risco').innerHTML = riscos.map(r => `<option value="${r === 'Todas' ? '' : r}">${r}</option>`).join('');
    
    if (riscos.includes(riscoAtual) || (riscoAtual === '' && riscos.includes('Todas'))) {
        document.getElementById('filter-risco').value = riscoAtual;
    } else {
        document.getElementById('filter-risco').value = ''; 
    }
}

function addFilterListeners() {
    document.getElementById('filter-unidade').addEventListener('change', function() {
        updateRiscoFilter(); 
        updateDashboard(); 
    });
    
    document.getElementById('filter-diagnostico').addEventListener('change', updateDashboard);
}

function clearFilters() {
    document.getElementById('filter-unidade').value = "";
    document.getElementById('filter-diagnostico').value = "";
    updateRiscoFilter(); 
    updateDashboard();
}

// --- FUNÇÕES DE ATUALIZAÇÃO DE KPIS ---
function updateTaxaClassificacaoFT() {
    const unidadeSelecionada = document.getElementById('filter-unidade').value || "Todas";
    const dados = taxaClassificacaoFT[unidadeSelecionada] || taxaClassificacaoFT["Todas"];
    
    document.querySelector('#kpi-adesao .kpi-value').textContent = `${dados.perc}%`;
    document.querySelector('#kpi-adesao .kpi-subtext').textContent = `${dados.ft} atendimentos FS de ${dados.total} atendimentos totais`;
}

function updateTempoEsperaCR() {
    const unidadeSelecionada = document.getElementById('filter-unidade').value || "Todas";
    const dados = tempoEsperaCR[unidadeSelecionada] || tempoEsperaCR["Todas"];
    
    document.querySelector('#kpi-espera-cr .kpi-comparison div:first-child .kpi-value').textContent = `${dados.ft}`;
    document.querySelector('#kpi-espera-cr .kpi-comparison div:last-child .kpi-value').textContent = `${dados.geral}`;
}

function updateTempoEsperaAtendimento() {
    const unidadeSelecionada = document.getElementById('filter-unidade').value || "Todas";
    const dados = tempoEsperaAtendimento[unidadeSelecionada] || tempoEsperaAtendimento["Todas"];
    
    document.querySelector('#kpi-espera-atendimento .kpi-comparison div:first-child .kpi-value').textContent = `${dados.ft}`;
    document.querySelector('#kpi-espera-atendimento .kpi-comparison div:last-child .kpi-value').textContent = `${dados.geral}`;
}

function updateTaxaRedirecionados() {
    const unidadeSelecionada = document.getElementById('filter-unidade').value || "Todas";
    const dados = taxaRedirecionados[unidadeSelecionada] || taxaRedirecionados["Todas"];
    
    document.querySelector('#kpi-taxa-adesao .kpi-value').textContent = `${dados.perc}%`;
    document.querySelector('#kpi-taxa-adesao .kpi-subtext').textContent = `${dados.finalizadosConv} atendimentos finalizados em fluxo convencional de ${dados.totalFT} atendimentos FT`;
}

function updateResolutividade() {
    const unidadeSelecionada = document.getElementById('filter-unidade').value || "Todas";
    const dados = resolutividade[unidadeSelecionada] || resolutividade["Todas"];
    
    document.querySelector('#kpi-resolutividade .kpi-comparison div:first-child .kpi-value').textContent = `${dados.percPrescricao}%`;
    document.querySelector('#kpi-resolutividade .kpi-comparison div:first-child .kpi-subtext').textContent = `Com Prescrição (${dados.prescricoes} de ${dados.totalFT} atendimentos FT)`;
    
    document.querySelector('#kpi-resolutividade .kpi-comparison div:last-child .kpi-value').textContent = `${dados.percChecagem}%`;
    document.querySelector('#kpi-resolutividade .kpi-comparison div:last-child .kpi-subtext').textContent = `Com Checagem (${dados.checagens} de ${dados.totalPrescricoes} prescrições)`;
}

function updateAtestados() {
    const unidadeSelecionada = document.getElementById('filter-unidade').value || "Todas";
    
    const ftData = atestadoFTCardData[unidadeSelecionada] || atestadoFTCardData["Todas"];
    document.getElementById('atestado-ft-perc').textContent = `${ftData.perc}%`;
    document.getElementById('atestado-ft-details').textContent = `${ftData.atestado} de ${ftData.total} atendimentos FT`;
    
    const nftData = atestadoNFTCardData[unidadeSelecionada] || atestadoNFTCardData["Todas"];
    document.getElementById('atestado-nft-perc').textContent = `${nftData.perc}%`;
    document.getElementById('atestado-nft-details').textContent = `${nftData.atestado} de ${nftData.total} atendimentos não FT`;
}

// --- FUNÇÕES PARA DADOS DE GRÁFICOS ---
function getHorariosGraficoFT() {
    const unidadeSelecionada = document.getElementById('filter-unidade').value || "Todas";
    return horariosFTChartData[unidadeSelecionada] || horariosFTChartData["Todas"];
}

function getHorariosGraficoNFT() {
    const unidadeSelecionada = document.getElementById('filter-unidade').value || "Todas";
    return horariosNFTChartData[unidadeSelecionada] || horariosNFTChartData["Todas"];
}

function getTop10CIDsFT() {
    const unidadeSelecionada = document.getElementById('filter-unidade').value || "Todas";
    return top10CIDsFT[unidadeSelecionada] || top10CIDsFT["Todas"];
}

function updateDashboard() {
    updateTaxaClassificacaoFT();
    updateTempoEsperaCR();
    updateTempoEsperaAtendimento();
    updateTaxaRedirecionados();
    updateResolutividade();
    updateAtestados();
    updateCharts();
}

function updateCharts() {
    const top10DiagsData = getTop10CIDsFT();
    
    if (chartDiagnosticos) chartDiagnosticos.destroy();
    chartDiagnosticos = new ApexCharts(document.querySelector("#chart-diagnosticos"), {
        series: [{ data: top10DiagsData.map(d => d.count) }],
        chart: { type: 'bar', height: 350 },
        plotOptions: { bar: { horizontal: true, distributed: true, dataLabels: { position: 'top' } } },
        dataLabels: { enabled: true, offsetX: 20, style: { colors: ['#333'] } },
        xaxis: { categories: top10DiagsData.map(d => d.cid) }, // Exibe apenas o código CID
        tooltip: {
            custom: function({ series, seriesIndex, dataPointIndex }) {
                const cidCode = top10DiagsData[dataPointIndex].cid;
                const value = series[seriesIndex][dataPointIndex];
                const descritivo = cidDescritivos[cidCode] || cidCode; // Usa a descrição completa no tooltip
                return `<div style="padding: 10px; background: #333; color: #fff; border-radius: 4px;"><strong>${descritivo}</strong><br/>${value} casos</div>`;
            }
        },
        legend: { show: false }
    });
    chartDiagnosticos.render();

    const unidadeSelecionada = document.getElementById('filter-unidade').value || "Todas";
    const atestadoData = atestadoFTChartData[unidadeSelecionada] || atestadoFTChartData["Todas"];

    if (chartAtestado) chartAtestado.destroy();
    chartAtestado = new ApexCharts(document.querySelector("#chart-atestado"), {
        series: [{ data: [atestadoData.comAtestado, atestadoData.semAtestado] }],
        chart: { type: 'bar', height: 350 },
        plotOptions: { bar: { distributed: true, dataLabels: { position: 'top' } } },
        dataLabels: { enabled: true, style: { fontSize: '14px', colors: ['#333'] } },
        xaxis: { categories: ['Com Atestado', 'Sem Atestado'] },
        legend: { show: false },
        yaxis: { title: { text: 'Quantidade de Atendimentos' } }
    });
    chartAtestado.render();

    const { horas: horasFT, dados: dadosFT } = getHorariosGraficoFT();
    const horasLabelsFT = horasFT.map(h => `${h}:00`);
    
    if (chartSazonalidade) chartSazonalidade.destroy();
    chartSazonalidade = new ApexCharts(document.querySelector("#chart-sazonalidade"), {
        series: [{ name: 'Atendimentos', data: dadosFT }],
        chart: { type: 'line', height: 350, zoom: { enabled: false } },
        xaxis: { categories: horasLabelsFT },
        stroke: { curve: 'smooth' },
        colors: [getComputedStyle(document.documentElement).getPropertyValue('--accent-color')]
    });
    chartSazonalidade.render();

    const { horas: horasNFT, dados: dadosNFT } = getHorariosGraficoNFT();
    const horasLabelsNFT = horasNFT.map(h => `${h}:00`);
    
    if (chartSazonalidadeNFT) chartSazonalidadeNFT.destroy();
    chartSazonalidadeNFT = new ApexCharts(document.querySelector("#chart-sazonalidade-nft"), {
        series: [{ name: 'Atendimentos', data: dadosNFT }],
        chart: { type: 'line', height: 350, zoom: { enabled: false } },
        xaxis: { categories: horasLabelsNFT },
        stroke: { curve: 'smooth' },
        colors: ['#FF6B6B']
    });
    chartSazonalidadeNFT.render();
}

function exportData() {
    // A função exportData ainda usa processedData, que é gerado a partir de rawData
    // e simula a estrutura original para exportação.
    const dataToExport = processedData.filter(d => 
        (document.getElementById('filter-unidade').value === "" || d['UNIDADE'] === document.getElementById('filter-unidade').value) &&
        (document.getElementById('filter-diagnostico').value === "" || d['CID'] === document.getElementById('filter-diagnostico').value)
    );
    const worksheet = XLSX.utils.json_to_sheet(dataToExport);
    const workbook = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(workbook, worksheet, "Dados Fast Track");
    XLSX.writeFile(workbook, "Relatorio_Fast_Track.xlsx");
}

</script>

</body>
</html>
